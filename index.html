<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP Consulting Group</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --sidebar-dark: #1e293b;
            --card-dark: #1e293b;
            --text-primary-dark: #f1f5f9;
            --text-secondary-dark: #94a3b8;
            --border-dark: #334155;
            --accent-dark: #60a5fa;
            --modal-overlay: rgba(15, 23, 42, 0.8);
            --input-dark: #131c31; 
        }
        html { background-color: var(--bg-dark); color: var(--text-primary-dark); }
        body { font-family: 'Inter', sans-serif; }
        .sidebar { background-color: var(--sidebar-dark); border-color: var(--border-dark); }
        .card, .auth-card { background-color: var(--card-dark); border-color: var(--border-dark); }
        .form-input { background-color: var(--sidebar-dark); border-color: var(--border-dark); color: var(--text-primary-dark); }
        .form-input[type="text"], .form-input[type="date"], .form-input[type="tel"], .form-input[type="email"], .form-input[type="number"] {
            background-color: var(--input-dark);
        }
        .form-input:focus { outline: none; border-color: var(--accent-dark); box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5); }
        .form-input.invalid { border-color: #f87171; }
        .employee-item.active { background-color: var(--accent-dark); color: #0f172a; }
        .employee-item.active .status-dot { background-color: #0f172a; }
        .employee-item.active p { color: #0f172a !important; }
        .spinner {
            width: 1.5rem; height: 1.5rem; border-radius: 50%;
            border: 2px solid var(--border-dark);
            border-top-color: var(--accent-dark);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { background-color: var(--modal-overlay); transition: opacity 0.3s ease; }
        .modal-content { background-color: var(--sidebar-dark); transition: transform 0.3s ease; }
        .filter-btn { background-color: var(--sidebar-dark); color: var(--text-secondary-dark); border: 1px solid var(--border-dark); }
        .filter-btn.active { background-color: var(--accent-dark); color: #0f172a; border-color: var(--accent-dark); }
    </style>
</head>
<body class="antialiased text-slate-200">

    <div id="auth-view" class="h-screen w-full flex items-center justify-center p-4">
        <div class="auth-card w-full max-w-sm p-8 rounded-lg shadow-xl border border-slate-800">
            <h1 class="text-2xl font-bold text-center mb-6">MVP Consulting Group</h1>
            <form id="login-form" class="space-y-4">
                <div><label for="email" class="block text-sm font-medium mb-1">Email</label><input type="email" id="email" name="email" class="form-input w-full p-2 rounded-md" required></div>
                <div><label for="password" class="block text-sm font-medium mb-1">Password</label><input type="password" id="password" name="password" class="form-input w-full p-2 rounded-md" required></div>
                <div class="flex flex-col space-y-2 pt-2"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md w-full">Sign In</button></div>
            </form>
        </div>
    </div>

    <div id="app-view" class="h-screen w-full flex overflow-hidden hidden"></div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <div id="app-templates" style="display: none;">
        <template id="dashboard-template">
            <div id="dashboard-view">
                <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-5 border rounded-lg"><h3 class="text-slate-400 text-sm font-medium">Active Employees</h3><p id="kpi-active" class="text-3xl font-bold mt-1"><div class="spinner"></div></p></div>
                    <div class="card p-5 border rounded-lg"><h3 class="text-slate-400 text-sm font-medium">Terminated Employees</h3><p id="kpi-terminated" class="text-3xl font-bold mt-1"><div class="spinner"></div></p></div>
                    <div class="card p-5 border rounded-lg"><h3 class="text-slate-400 text-sm font-medium">Total Dependents</h3><p id="kpi-dependents" class="text-3xl font-bold mt-1"><div class="spinner"></div></p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3 card p-5 border rounded-lg"><h3 class="font-semibold mb-4">Benefit Plan Popularity</h3><div class="h-64 relative"><canvas id="plan-popularity-chart"></canvas></div></div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card p-5 border rounded-lg"><h3 class="font-semibold mb-3">Recently Added</h3><ul id="recent-employees-list" class="space-y-2 text-sm"></ul></div>
                        <div class="card p-5 border rounded-lg"><h3 class="font-semibold mb-3">Active Employees w/o Benefits</h3><ul id="unenrolled-employees-list" class="space-y-2 text-sm"></ul></div>
                    </div>
                </div>
            </div>
        </template>
        <template id="empty-state-template">
            <div class="h-full flex flex-col justify-center items-center text-center">
                <svg class="h-16 w-16 text-slate-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                <h2 class="text-xl font-semibold">Select an Employee</h2>
                <p class="text-slate-400 mt-1">Choose an employee from the list to view their details.</p>
            </div>
        </template>
        <template id="employee-details-template">
             <div>
                <button id="back-to-dashboard" class="text-sm text-blue-400 hover:underline mb-6 flex items-center space-x-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg><span>Back to Dashboard</span></button>
                <div id="employee-details-content">
                     <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="employee-initials flex-shrink-0 h-20 w-20 rounded-full bg-slate-700 flex items-center justify-center text-3xl font-bold text-slate-500"></div>
                            <div class="sm:ml-6"><h2 class="employee-full-name text-3xl font-bold"></h2><p class="employee-occupation text-lg text-slate-400"></p></div>
                        </div>
                        <div class="flex space-x-2 mt-4 sm:mt-0">
                            <button id="edit-employee-btn" class="p-2 rounded-md hover:bg-slate-700" title="Edit Enrollment"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button id="delete-employee-btn" class="p-2 rounded-md hover:bg-slate-700" title="Delete Employee"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="card p-6 border rounded-lg"><h3 class="font-semibold text-xl mb-4">Employee Information</h3><div class="employee-info-grid grid grid-cols-2 gap-x-4 gap-y-2 text-sm"></div></div>
                             <div class="card p-6 border rounded-lg mt-8">
                                <h3 class="font-semibold text-xl mb-4">Dependents & Beneficiaries</h3>
                                <h4 class="font-medium text-slate-300 mb-2">Dependents</h4><ul class="dependents-list list-disc list-inside space-y-1 mb-4"></ul>
                                <h4 class="font-medium text-slate-300 mb-2">Beneficiaries</h4><ul class="beneficiaries-list list-disc list-inside space-y-1"></ul>
                            </div>
                        </div>
                         <div class="card p-6 border rounded-lg"><h3 class="font-semibold text-xl mb-4">Elected Benefits</h3><div class="elections-list space-y-2 text-sm"></div></div>
                    </div>
                    <div class="card p-6 border rounded-lg mt-8"><h3 class="font-semibold text-xl mb-3">Generated Summary</h3><div id="summary-content" class="text-slate-300"></div></div>
                </div>
            </div>
        </template>
        <template id="enrollment-form-template">
            <form id="enrollment-form" class="space-y-6">
                <div id="validation-errors" class="hidden bg-red-900/50 border border-red-700 text-red-300 text-sm p-3 rounded-md"></div>
                <fieldset class="space-y-4 p-4 border border-slate-700 rounded-lg"><legend class="text-lg font-semibold text-slate-300 px-2">Employee Information</legend><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm mb-1">Full Name</label><input type="text" name="full_name" class="form-input w-full p-2 rounded-md" required></div><div><label class="block text-sm mb-1">Date of Birth</label><input type="date" name="birthdate" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Phone #</label><input type="tel" name="phone" placeholder="nnn-nnn-nnnn" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Social Security #</label><input type="text" name="social_security_number" placeholder="nnn-nn-nnnn" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Email</label><input type="email" name="email" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Gender</label><select name="gender" class="form-input w-full p-2 rounded-md"><option value="">Select...</option><option value="Male">Male</option><option value="Female">Female</option></select></div><div class="md:col-span-3"><label class="block text-sm mb-1">Address</label><input type="text" name="address" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">City</label><input type="text" name="city" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">State</label><input type="text" name="state" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Zip</label><input type="text" name="zip" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Date of Hire</label><input type="date" name="date_of_hire" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Occupation</label><input type="text" name="occupation" class="form-input w-full p-2 rounded-md"></div><div><label class="block text-sm mb-1">Status</label><select name="status" class="form-input w-full p-2 rounded-md"><option>Active</option><option>Terminated</option><option>On Leave</option></select></div></div></fieldset>
                <fieldset class="p-4 border border-slate-700 rounded-lg"><legend class="text-lg font-semibold text-slate-300 px-2">Eligibility Questions</legend><div id="eligibility-container" class="space-y-3 text-sm"></div></fieldset>
                <fieldset class="p-4 border border-slate-700 rounded-lg"><legend class="text-lg font-semibold text-slate-300 px-2">Dependents</legend><div id="dependents-container" class="space-y-3"></div><button type="button" id="add-dependent-btn" class="text-sm text-blue-400 hover:underline mt-2">+ Add Dependent</button></fieldset>
                <fieldset class="p-4 border border-slate-700 rounded-lg"><legend class="text-lg font-semibold text-slate-300 px-2">Beneficiaries</legend><div id="beneficiaries-container" class="space-y-3"></div><button type="button" id="add-beneficiary-btn" class="text-sm text-blue-400 hover:underline mt-2">+ Add Beneficiary</button></fieldset>
                <fieldset class="p-4 border border-slate-700 rounded-lg"><legend class="text-lg font-semibold text-slate-300 px-2">Benefit Elections</legend><div class="flex items-end space-x-2 mb-4"><div class="flex-grow"><label for="benefit-plan-select" class="block text-sm mb-1">Select a Plan</label><select id="benefit-plan-select" class="form-input w-full p-2 rounded-md"><option value="Accident">Accident</option><option value="Hospital">Hospital</option><option value="Critical-Illness">Critical Illness</option><option value="Whole-Life">Whole Life</option><option value="Term-Life">Term Life/AD&D</option></select></div><button type="button" id="add-benefit-plan-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Add</button></div><div id="benefits-selection-container" class="space-y-4"></div></fieldset>
                <fieldset class="p-4 border border-slate-700 rounded-lg"><legend class="text-lg font-semibold text-slate-300 px-2">Acknowledgement & Signature</legend><div class="flex items-start space-x-3 mb-6"><input type="checkbox" id="decline_all" name="decline_all" class="form-input h-5 w-5 rounded mt-1 flex-shrink-0"><div class="flex-1"><label for="decline_all" class="font-bold text-slate-100">NO THANK YOU - I wish to decline this coverage.</label><p class="text-xs text-slate-400 mt-1">By signing below, you acknowledge that you are declining the opportunity to enroll during your open enrollment period without health questions. Future enrollment may require health questions to qualify.</p></div></div><h4 class="font-semibold mb-2 text-slate-100">APPLICANT'S STATEMENTS AND AGREEMENTS:</h4><p class="text-xs text-slate-400 border border-slate-700 bg-slate-900/50 p-3 rounded-md">I have read or had read to me the completed application. I represent that all statements and answers made on or attached to this application are true to the best of my knowledge and belief, and realize that any false statements herein which materially affect the acceptance of the risk or hazard assumed may result in loss of coverage under the policy/certificate to which this application is attached. I understand that coverage will become effective only after all of the following conditions have been met: a) I must be a member of an eligible class; b) I must have satisfied the policyholder waiting period; c)the group must have met the insurer's minimum participation requirement; d) I must satisfactorily answer all questions on this form; e) I must be actively at work on the effective date (according to the insurer's rules); and f) the first month's premium must have been received by the underwriting company and its administrative office. I understand that completion of this application in no way implies that I will be accepted for insurance coverage.</p><div class="mt-4"><label class="block text-sm">Employee Signature (Type Full Name)</label><input type="text" name="signature_name" class="form-input w-full p-2 rounded-md md:w-1/2"></div></fieldset>
                <div class="pt-4 flex justify-end"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Submit</button></div>
            </form>
        </template>
        <template id="dependent-row-template"><div class="dependent-row grid grid-cols-2 md:grid-cols-6 gap-2 border border-slate-800 p-2 rounded items-center"><select name="rel_type" class="form-input text-sm p-2 rounded-md"><option value="Spouse">Spouse</option><option value="Child">Child</option></select><input type="text" name="dep_full_name" placeholder="Full Name" class="form-input text-sm p-2 rounded-md"><input type="date" name="dep_dob" class="form-input text-sm p-2 rounded-md"><select name="dep_gender" class="form-input text-sm p-2 rounded-md"><option value="">Gender</option><option value="Male">Male</option><option value="Female">Female</option></select><input type="text" name="dep_ssn" placeholder="SSN (Spouse)" class="form-input text-sm p-2 rounded-md"><button type="button" class="remove-row-btn text-red-400 hover:text-red-600 justify-self-center text-xl">&times;</button></div></template>
        <template id="beneficiary-row-template"><div class="beneficiary-row grid grid-cols-2 md:grid-cols-5 gap-2 border border-slate-800 p-2 rounded items-center"><select name="kind" class="form-input text-sm p-2 rounded-md"><option value="Primary">Primary</option><option value="Contingent">Contingent</option></select><input type="text" name="ben_full_name" placeholder="Full Name" class="form-input text-sm p-2 rounded-md"><input type="text" name="relationship" placeholder="Relationship" class="form-input text-sm p-2 rounded-md"><input type="number" name="percentage" placeholder="%" class="form-input text-sm p-2 rounded-md" step="0.01"><button type="button" class="remove-row-btn text-red-400 hover:text-red-600 justify-self-center text-xl">&times;</button></div></template>
        <template id="Accident-plan-template"><h4 class="font-semibold text-lg mb-2">Accident Insurance</h4><div class="flex flex-wrap gap-x-6 gap-y-2 mt-2 text-sm radio-group"></div></template>
        <template id="Hospital-plan-template"><h4 class="font-semibold text-lg mb-2">Hospital Indemnity</h4><div class="flex flex-wrap gap-x-6 gap-y-2 mt-2 text-sm radio-group"></div></template>
        <template id="Critical-Illness-plan-template"><h4 class="font-semibold text-lg mb-2">Critical Illness w/Cancer</h4><p class="text-xs text-slate-400">Select a plan below.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div id="ci-10k"></div><div id="ci-20k"></div></div></template>
        <template id="Whole-Life-plan-template"><h4 class="font-semibold text-lg mb-2">Whole Life</h4><p class="text-xs text-slate-400">Select a benefit amount.</p><div class="mt-2 space-y-3" id="wl-container"></div></template>
        <template id="Term-Life-plan-template"><h4 class="font-semibold text-lg mb-2">Term Life and AD&D</h4><p class="text-xs text-slate-400">Select a benefit amount.</p><div class="mt-2 space-y-3" id="tl-container"></div></template>
    </div>

    <script>
        // --- SCRIPT START ---
        // (The rest of the file is unchanged, but included for completeness)
        const { createClient } = supabase;
        const supabaseUrl = 'https://dvbikzjpszfwffrbrddu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2Ymlrempwc3pmd2ZmcmJyZGR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NDY1NjcsImV4cCI6MjA2NTMyMjU2N30.Fevr5skv_ZkxeSC3l7oaZt1wD4DG5nqkoUl4zxaDgSo';
        let supabaseClient;
        const EMPLOYEES_PER_PAGE = 30;
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        let appState = { employees: [], selectedEmployeeId: null, currentPage: 0, isLoadingMore: false, hasMore: true, user: null, statusFilter: 'all', isInitialized: false, isFormDirty: false, };
        document.addEventListener('DOMContentLoaded', () => { initializeSupabase(); setupAuthListeners(); checkUserSession(); });
        function initializeSupabase() { try { supabaseClient = createClient(supabaseUrl, supabaseKey); } catch (error) { console.error("Supabase initialization failed:", error); } }
        async function initializeApp() { if (appState.isInitialized) return; try { appView.innerHTML = `<aside class="sidebar w-full md:w-1/3 lg:w-1/4 border-r border-slate-800 flex flex-col"><header class="p-4 border-b border-slate-800 flex justify-between items-center flex-shrink-0"><div class="flex items-center space-x-2"><svg class="h-6 w-6 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-2.438M15 19.128v-3.872M15 19.128l-3.262-3.262a5.03 5.03 0 00-7.072-7.072l-3.262 3.262M15 19.128l2.104-2.104a5.035 5.035 0 000-7.072M9 15v3.872M9 15l-3.262-3.262a5.03 5.03 0 010-7.072L9 4.664M9 15l2.104-2.104a5.035 5.035 0 017.072 0" /></svg><h1 class="text-lg font-bold">MVP Consulting Group</h1></div><div class="flex items-center space-x-2"><button id="export-csv-btn" class="p-2 rounded-full hover:bg-slate-700 cursor-pointer" title="Export All to CSV"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></button><button id="settings-btn" class="p-2 rounded-full hover:bg-slate-700 cursor-pointer" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734-2.106-2.106a1.533 1.533 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg></button><button id="add-entry-btn" class="p-2 rounded-full hover:bg-slate-700 cursor-pointer" title="New Enrollment"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button><button id="logout-btn" class="p-2 rounded-full hover:bg-slate-700 cursor-pointer" title="Logout"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg></button></div></header><div class="p-4 flex-shrink-0 space-y-4"><input type="text" id="searchName" class="form-input w-full px-3 py-2 border rounded-md" placeholder="Search by name..."><div id="status-filter-group" class="flex items-center space-x-2"><button data-status="all" class="filter-btn active flex-1 text-sm py-1 px-2 rounded-md">All</button><button data-status="Active" class="filter-btn flex-1 text-sm py-1 px-2 rounded-md">Active</button><button data-status="Terminated" class="filter-btn flex-1 text-sm py-1 px-2 rounded-md">Terminated</button></div></div><div id="employee-list-container" class="flex-grow overflow-y-auto"><ul id="employee-list" class="divide-y divide-slate-800"></ul><div id="infinite-loader" class="h-16 flex items-center justify-center hidden"><div class="spinner"></div></div></div></aside><main id="main-content" class="w-full md:w-2/3 lg:w-3/4 bg-slate-900/50 overflow-y-auto p-4 sm:p-6 lg:p-8"></main>`; createModals(); setupAppEventListeners(); await fetchEmployees(true); renderEmptyState(); appState.isInitialized = true; } catch (e) { console.error("Critical error:", e); appView.innerHTML = `<div class="text-center p-8 text-red-400"><h2 class="text-xl font-bold">A critical error occurred</h2><p>${e.message}</p></div>`; } }
        function setupAuthListeners() { loginForm.addEventListener('submit', handleSignIn); supabaseClient.auth.onAuthStateChange((event, session) => { if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') { appState.user = session?.user; showApp(); } else if (event === 'SIGNED_OUT') { appState.user = null; showAuth(); } }); }
        function setupAppEventListeners() { document.getElementById('searchName').addEventListener('input', debounce(handleSearch, 300)); document.getElementById('logout-btn').addEventListener('click', handleSignOut); document.getElementById('employee-list-container').addEventListener('scroll', handleScroll); document.getElementById('add-entry-btn').addEventListener('click', () => openModal()); document.getElementById('settings-btn').addEventListener('click', openSettingsModal); document.getElementById('export-csv-btn').addEventListener('click', handleExportCSV); document.querySelectorAll('#status-filter-group .filter-btn').forEach(btn => btn.addEventListener('click', handleStatusFilter)); }
        async function checkUserSession() { const { data: { session } } = await supabaseClient.auth.getSession(); if (session) { appState.user = session.user; showApp(); } else { showAuth(); } }
        async function handleSignIn(e) { e.preventDefault(); const formData = new FormData(e.target); const { email, password } = Object.fromEntries(formData.entries()); const { error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) showToast(error.message, 'error'); }
        async function handleSignOut() { await supabaseClient.auth.signOut(); }
        function showApp() { authView.classList.add('hidden'); appView.classList.remove('hidden'); if (!appState.isInitialized) initializeApp(); }
        function showAuth() { authView.classList.remove('hidden'); appView.classList.add('hidden'); appState = { ...appState, employees: [], selectedEmployeeId: null, currentPage: 0, hasMore: true, statusFilter: 'all', isInitialized: false }; }
        async function fetchEmployees(isInitial = false, query = '') { if (appState.isLoadingMore) return; appState.isLoadingMore = true; if (isInitial) { appState.currentPage = 0; appState.employees = []; appState.hasMore = true; } const loader = document.getElementById('infinite-loader'); if (loader) loader.classList.remove('hidden'); const from = appState.currentPage * EMPLOYEES_PER_PAGE; const to = from + EMPLOYEES_PER_PAGE - 1; let request = supabaseClient.from('employees').select('*').order('full_name', { ascending: true }).range(from, to); if (query) request = request.ilike('full_name', `%${query}%`); if (appState.statusFilter !== 'all') request = request.eq('status', appState.statusFilter); const { data, error } = await request; if (error) { console.error("Error fetching employees:", error); showToast(error.message, 'error'); appState.isLoadingMore = false; return; } appState.employees.push(...data); if (data.length < EMPLOYEES_PER_PAGE) appState.hasMore = false; renderEmployeeList(); appState.currentPage++; appState.isLoadingMore = false; if (loader) loader.classList.add('hidden'); }
        function handleScroll(e) { const { scrollTop, scrollHeight, clientHeight } = e.target; const isSearching = document.getElementById('searchName').value.trim() !== ''; if (scrollTop + clientHeight >= scrollHeight - 100 && !appState.isLoadingMore && appState.hasMore && !isSearching) { fetchEmployees(); } }
        async function handleSearch(event) { const query = event.target.value.trim(); appState.selectedEmployeeId = null; renderEmptyState(); await fetchEmployees(true, query); }
        function handleStatusFilter(event) { const status = event.target.dataset.status; if (status === appState.statusFilter) return; appState.statusFilter = status; appState.selectedEmployeeId = null; renderEmptyState(); updateFilterButtonsUI(); const query = document.getElementById('searchName').value.trim(); fetchEmployees(true, query); }
        function updateFilterButtonsUI() { const filterGroup = document.getElementById('status-filter-group'); if (!filterGroup) return; filterGroup.querySelectorAll('.filter-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.status === appState.statusFilter); }); }
        function renderEmployeeList() { const employeeListEl = document.getElementById('employee-list'); if (!employeeListEl) return; if (appState.currentPage === 0) employeeListEl.innerHTML = ''; if (appState.employees.length === 0 && appState.currentPage === 0) { employeeListEl.innerHTML = `<li class="p-4 text-center text-slate-500">No employees found.</li>`; return; } const fragment = document.createDocumentFragment(); appState.employees.forEach(employee => { const existingLi = employeeListEl.querySelector(`[data-employee-id='${employee.id}']`); if (!existingLi) { const li = document.createElement('li'); li.className = `employee-item p-4 flex items-center cursor-pointer hover:bg-slate-700/50`; li.dataset.employeeId = employee.id; const statusColor = employee.status === 'Active' ? 'bg-green-500' : 'bg-slate-500'; li.innerHTML = `<div class="status-dot h-2.5 w-2.5 rounded-full mr-4 flex-shrink-0 ${statusColor}"></div><div><h3 class="font-semibold">${employee.full_name}</h3><p class="text-sm text-slate-400">${employee.occupation || 'N/A'}</p></div>`; li.addEventListener('click', () => handleEmployeeSelection(employee.id)); fragment.appendChild(li); } }); employeeListEl.appendChild(fragment); employeeListEl.querySelectorAll('.employee-item').forEach(li => { li.classList.toggle('active', li.dataset.employeeId == appState.selectedEmployeeId); }); }
        async function handleEmployeeSelection(employeeId) { appState.selectedEmployeeId = employeeId; renderEmployeeList(); const mainContentEl = document.getElementById('main-content'); mainContentEl.innerHTML = `<div class="h-full flex items-center justify-center"><div class="spinner"></div></div>`; const employee = appState.employees.find(e => e.id === employeeId); const [{ data: dependents }, { data: beneficiaries }, { data: elections }, { data: acknowledgement }] = await Promise.all([supabaseClient.from('dependents').select('*').eq('employee_id', employeeId), supabaseClient.from('beneficiaries').select('*').eq('employee_id', employeeId), supabaseClient.from('elections').select('*').eq('employee_id', employeeId), supabaseClient.from('election_acknowledgements').select('*').eq('employee_id', employeeId).single()]); const relatedData = { dependents, beneficiaries, elections, acknowledgement }; renderEmployeeDetails(employee, relatedData); getAiSummary(employee, relatedData); }
        function renderEmptyState() { const mainContentEl = document.getElementById('main-content'); mainContentEl.innerHTML = ''; const template = document.getElementById('empty-state-template'); if (template) { const clone = template.content.cloneNode(true); mainContentEl.appendChild(clone); } }
        function renderEmployeeDetails(employee, relatedData) { const detailsView = document.getElementById('main-content'); detailsView.innerHTML = ''; const template = document.getElementById('employee-details-template'); const clone = template.content.cloneNode(true); const { dependents = [], beneficiaries = [], elections = [] } = relatedData; clone.querySelector('.employee-initials').textContent = employee.full_name.split(' ').map(n => n[0]).join(''); clone.querySelector('.employee-full-name').textContent = employee.full_name; clone.querySelector('.employee-occupation').textContent = employee.occupation || 'No Occupation'; const infoGrid = clone.querySelector('.employee-info-grid'); infoGrid.innerHTML = `<p><strong>Status:</strong> <span class="px-2 py-1 text-xs rounded-full ${employee.status === 'Active' ? 'bg-green-900/50 text-green-400' : 'bg-slate-700/50'}">${employee.status}</span></p><p><strong>Hire Date:</strong> ${employee.date_of_hire ? new Date(employee.date_of_hire + 'T00:00:00').toLocaleDateString() : 'N/A'}</p><p><strong>DOB:</strong> ${employee.birthdate ? new Date(employee.birthdate + 'T00:00:00').toLocaleDateString() : 'N/A'}</p><p><strong>Phone:</strong> ${employee.phone || 'N/A'}</p><p class="col-span-2"><strong>Email:</strong> ${employee.email || 'N/A'}</p><p class="col-span-2"><strong>Address:</strong> ${`${employee.address || ''}, ${employee.city || ''}, ${employee.state || ''} ${employee.zip || ''}`}</p><p class="col-span-2 flex items-center"><strong>SSN:</strong>&nbsp;<span id="ssn-display">${maskSSN(employee.social_security_number)}</span> <button id="toggle-ssn-btn" class="ml-2 text-xs text-blue-400 hover:underline">[Show]</button></p>`; clone.querySelector('.dependents-list').innerHTML = dependents.length > 0 ? dependents.map(d => `<li class="text-sm">${d.full_name} (${d.rel_type})</li>`).join('') : '<li class="text-sm text-slate-500">No dependents listed.</li>'; clone.querySelector('.beneficiaries-list').innerHTML = beneficiaries.length > 0 ? beneficiaries.map(b => `<li class="text-sm">${b.full_name} (${b.kind}) - ${b.percentage || 0}%</li>`).join('') : '<li class="text-sm text-slate-500">No beneficiaries listed.</li>'; clone.querySelector('.elections-list').innerHTML = elections.length > 0 ? elections.map(e => `<div class="p-3 mb-2 border border-slate-700 rounded-md bg-slate-800"><p class="font-semibold text-blue-400">${e.product}</p><p><strong>Coverage:</strong> ${e.coverage_tier || ''}</p><p><strong>Premium:</strong> $${e.premium_amount || 'N/A'}</p></div>`).join('') : '<p class="text-sm text-slate-500">No benefits elected.</p>'; detailsView.appendChild(clone); document.getElementById('edit-employee-btn').addEventListener('click', () => openModal(employee, relatedData)); document.getElementById('delete-employee-btn').addEventListener('click', () => openDeleteConfirm(employee.id)); document.getElementById('toggle-ssn-btn').addEventListener('click', () => toggleSSN(employee.social_security_number)); }
        function createModals() { const modalHtml = `<div id="enrollment-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div class="modal-overlay absolute inset-0"></div><div class="modal-content w-full max-w-5xl max-h-[90vh] rounded-lg shadow-xl z-10 flex flex-col"><header class="p-4 border-b border-slate-700 flex justify-between items-center flex-shrink-0"><h2 id="modal-title" class="text-xl font-bold"></h2><button class="close-modal-btn p-2 rounded-full hover:bg-slate-700 text-2xl leading-none">&times;</button></header><div id="modal-body" class="p-6 flex-grow overflow-y-auto"></div><div id="modal-loader" class="absolute inset-0 bg-slate-800/80 flex items-center justify-center hidden"><div class="spinner"></div></div></div></div><div id="confirm-delete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div class="modal-overlay absolute inset-0"></div><div class="modal-content w-full max-w-md rounded-lg shadow-xl z-10 p-6"><h2 class="text-xl font-bold mb-4">Are you sure?</h2><p class="text-slate-400 mb-6">This will permanently delete the employee and all associated data.</p><div class="flex justify-end space-x-4"><button class="cancel-delete-btn bg-slate-600 hover:bg-slate-700 font-bold py-2 px-4 rounded-md">Cancel</button><button id="confirm-delete-action-btn" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-md">Delete</button></div></div></div><div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div class="modal-overlay absolute inset-0"></div><div class="modal-content w-full max-w-md rounded-lg shadow-xl z-10 p-6"><h2 class="text-xl font-bold mb-4">Settings</h2><form id="settings-form"><div class="mb-4"><label for="google-api-key" class="block text-sm font-medium mb-1">Google AI API Key</label><input type="password" id="google-api-key" class="form-input w-full p-2 rounded-md"><p class="text-xs text-slate-400 mt-1">Stored in local storage.</p></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-settings-btn bg-slate-600 hover:bg-slate-700 font-bold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-md">Save</button></div></form></div></div>`; appView.insertAdjacentHTML('beforeend', modalHtml); appView.querySelectorAll('.modal-overlay, .close-modal-btn, .cancel-delete-btn, .cancel-settings-btn').forEach(el => el.addEventListener('click', closeModal)); document.getElementById('settings-form').addEventListener('submit', handleSettingsSave); }
        function openModal(employeeToEdit = null, relatedData = {}) { const modal = document.getElementById('enrollment-modal'); const modalTitle = modal.querySelector('#modal-title'); const modalBody = modal.querySelector('#modal-body'); const isEditMode = !!employeeToEdit; appState.isFormDirty = false; modalTitle.textContent = isEditMode ? `Edit: ${employeeToEdit.full_name}` : 'New Enrollment'; const { dependents = [], beneficiaries = [], elections = [], acknowledgement } = relatedData; const template = document.getElementById('enrollment-form-template'); const clone = template.content.cloneNode(true); const form = clone.querySelector('#enrollment-form'); form.dataset.employeeId = isEditMode ? employeeToEdit.id : ''; if(isEditMode) { Object.keys(employeeToEdit).forEach(key => { const input = form.querySelector(`[name="${key}"]`); if(input) input.value = employeeToEdit[key]; }); form.querySelector('button[type="submit"]').textContent = 'Save Changes'; } const eligibilityContainer = form.querySelector('#eligibility-container'); eligibilityContainer.innerHTML = [ getEligibilityCheckbox('actively_at_work', 'Actively at work full time?', employeeToEdit?.actively_at_work), getEligibilityCheckbox('used_tobacco_12mo', 'Used tobacco in last 12 months?', employeeToEdit?.used_tobacco_12mo), getEligibilityCheckbox('any_disabled_proposed_insured', 'Any proposed insured currently disabled?', employeeToEdit?.any_disabled_proposed_insured), getEligibilityCheckbox('title_xix_medicaid', 'Covered by Title XIX (e.g. Medicaid)?', employeeToEdit?.title_xix_medicaid) ].join(''); if(acknowledgement) { form.querySelector('[name="decline_all"]').checked = acknowledgement.declined_all; form.querySelector('[name="signature_name"]').value = acknowledgement.signature_name; } modalBody.innerHTML = ''; modalBody.appendChild(clone); dependents.forEach(d => addDependentRow(d)); beneficiaries.forEach(b => addBeneficiaryRow(b)); elections.forEach(e => addBenefitPlanForm(e.product, e)); updateBenefitDropdown(); form.addEventListener('input', () => { appState.isFormDirty = true; }); modal.querySelector('#add-dependent-btn').addEventListener('click', () => addDependentRow()); modal.querySelector('#add-beneficiary-btn').addEventListener('click', () => addBeneficiaryRow()); modal.querySelector('#add-benefit-plan-btn').addEventListener('click', handleAddBenefitPlan); modal.querySelector('#enrollment-form').addEventListener('submit', handleEnrollmentSubmit); modal.classList.remove('hidden'); }
        function handleAddBenefitPlan() { const container = document.getElementById('benefits-selection-container'); if (container.children.length >= 10) { showToast('Max 10 plans.', 'error'); return; } const select = document.getElementById('benefit-plan-select'); if (select.value) { addBenefitPlanForm(select.value); updateBenefitDropdown(); appState.isFormDirty = true; } }
        function updateBenefitDropdown() { const addedPlans = Array.from(document.getElementById('benefits-selection-container').children).map(c => c.dataset.planName); const select = document.getElementById('benefit-plan-select'); Array.from(select.options).forEach(opt => { opt.style.display = addedPlans.includes(opt.value) ? 'none' : 'block'; }); for (let opt of select.options) { if (opt.style.display !== 'none') { select.value = opt.value; return; } } select.value = ''; }
        function addBenefitPlanForm(planName, election = {}) { const container = document.getElementById('benefits-selection-container'); const template = document.getElementById(`${planName}-plan-template`); if(!template) return; const clone = template.content.cloneNode(true); const div = document.createElement('div'); div.className = 'benefit-plan-form p-4 border border-slate-700 rounded-lg relative'; div.dataset.planName = planName; div.innerHTML = `<button type="button" class="remove-plan-btn absolute top-2 right-2 text-red-400 hover:text-red-600 text-xl leading-none">&times;</button>`; div.appendChild(clone); const radioGroup = div.querySelector('.radio-group'); if (radioGroup) { switch(planName) { case 'Accident': radioGroup.innerHTML = [getElectionRadio('Accident', 'Employee', 2.83, election, 'Employee'), getElectionRadio('Accident', 'Employee + Children', 4.05, election, 'Employee + Children'), getElectionRadio('Accident', 'Employee + Spouse', 4.38, election, 'Employee + Spouse'), getElectionRadio('Accident', 'Family', 5.76, election, 'Family')].join(''); break; case 'Hospital': radioGroup.innerHTML = [getElectionRadio('Hospital', 'Employee', 3.46, election, 'Employee'), getElectionRadio('Hospital', 'Employee + Children', 5.08, election, 'Employee + Children'), getElectionRadio('Hospital', 'Employee + Spouse', 7.35, election, 'Employee + Spouse'), getElectionRadio('Hospital', 'Family', 8.32, election, 'Family')].join(''); break; } } if(planName === 'Critical-Illness') { div.querySelector('#ci-10k').innerHTML = `<h5>$10k Benefit</h5>` + [getElectionRadio('Critical-Illness', 'Employee', 0, election, 'Employee', 10000), getElectionRadio('Critical-Illness', 'EE + Children', 0, election, 'EE + Children', 10000), getElectionRadio('Critical-Illness', 'EE + Spouse', 0, election, 'EE + Spouse', 10000), getElectionRadio('Critical-Illness', 'Family', 0, election, 'Family', 10000)].join(''); div.querySelector('#ci-20k').innerHTML = `<h5>$20k Benefit</h5>` + [getElectionRadio('Critical-Illness', 'Employee', 0, election, 'Employee', 20000), getElectionRadio('Critical-Illness', 'EE + Children', 0, election, 'EE + Children', 20000), getElectionRadio('Critical-Illness', 'EE + Spouse', 0, election, 'EE + Spouse', 20000), getElectionRadio('Critical-Illness', 'Family', 0, election, 'Family', 20000)].join(''); } if (planName === 'Whole-Life') { const wlContainer = div.querySelector('#wl-container'); wlContainer.innerHTML = `<div><label class="text-sm font-medium">Employee Benefit</label><select name="whole_life_employee_amount" class="form-input w-full p-2 rounded-md mt-1"><option value="">None</option><option value="25000">$25,000</option><option value="50000">$50,000</option><option value="75000">$75,000</option><option value="100000">$100,000</option><option value="150000">$150,000</option></select></div><div><label class="text-sm font-medium">Spouse Benefit</label><select name="whole_life_spouse_amount" class="form-input w-full p-2 rounded-md mt-1"><option value="">None</option><option value="10000">$10,000</option><option value="25000">$25,000</option><option value="50000">$50,000</option><option value="75000">$75,000</option></select></div><div><label class="text-sm font-medium">Children Benefit</label><div class="flex flex-wrap gap-x-6 gap-y-2 mt-2 text-sm">${getElectionRadio('Whole-Life', 'Child $10k', 1.16, election, 'Children', 10000)}${getElectionRadio('Whole-Life', 'Child $20k', 2.32, election, 'Children', 20000)}</div></div>`; } if(planName === 'Term-Life') { const tlContainer = div.querySelector('#tl-container'); tlContainer.innerHTML = `<div><label class="text-sm font-medium">Employee Benefit</label><select name="term_life_employee_amount" class="form-input w-full p-2 rounded-md mt-1"><option value="">None</option><option value="50000">$50,000</option><option value="100000">$100,000</option><option value="150000">$150,000</option><option value="200000">$200,000</option></select></div><div><label class="text-sm font-medium">Spouse Benefit</label><select name="term_life_spouse_amount" class="form-input w-full p-2 rounded-md mt-1"><option value="">None</option><option value="25000">$25,000</option><option value="50000">$50,000</option><option value="75000">$75,000</option><option value="100000">$100,000</option></select></div><div><label class="text-sm font-medium">Children Benefit</label><div class="flex flex-wrap gap-x-6 gap-y-2 mt-2 text-sm">${getElectionRadio('Term-Life', 'Child $5k', 0.09, election, 'Children', 5000)}${getElectionRadio('Term-Life', 'Child $10k', 0.46, election, 'Children', 10000)}</div></div>`; } div.querySelector('.remove-plan-btn').addEventListener('click', () => { div.remove(); updateBenefitDropdown(); appState.isFormDirty = true; }); container.appendChild(div); }
        function getEligibilityCheckbox(name, label, isChecked) { return `<div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-md"><label for="${name}">${label}</label><input type="checkbox" id="${name}" name="${name}" class="form-input h-5 w-5 rounded" ${isChecked ? 'checked' : ''}></div>`; }
        function getElectionRadio(product, tierText, premium, election, tierValue, amount = null) { const isChecked = election.product === product && election.coverage_tier === tierValue && (amount ? election.coverage_amount == amount : true); const premiumText = premium > 0 ? `($${premium})` : ``; return `<label class="flex items-center space-x-2"><input type="radio" name="${product}_${tierValue}_${amount || ''}" value="${premium}" data-tier="${tierValue}" data-product="${product}" data-amount="${amount || 0}" ${isChecked ? 'checked': ''} class="form-input h-4 w-4"><span>${tierText} ${premiumText}</span></label>`; }
        function addDependentRow(dependent = {}) { const template = document.getElementById('dependent-row-template'); const clone = template.content.cloneNode(true); const div = clone.querySelector('.dependent-row'); if(dependent.rel_type) div.querySelector('[name="rel_type"]').value = dependent.rel_type; if(dependent.full_name) div.querySelector('[name="dep_full_name"]').value = dependent.full_name; if(dependent.dob) div.querySelector('[name="dep_dob"]').value = dependent.dob; if(dependent.gender) div.querySelector('[name="dep_gender"]').value = dependent.gender; if(dependent.ssn) div.querySelector('[name="dep_ssn"]').value = dependent.ssn; div.querySelector('.remove-row-btn').addEventListener('click', () => { div.remove(); appState.isFormDirty = true; }); document.getElementById('dependents-container').appendChild(clone); }
        function addBeneficiaryRow(beneficiary = {}) { const template = document.getElementById('beneficiary-row-template'); const clone = template.content.cloneNode(true); const div = clone.querySelector('.beneficiary-row'); if(beneficiary.kind) div.querySelector('[name="kind"]').value = beneficiary.kind; if(beneficiary.full_name) div.querySelector('[name="ben_full_name"]').value = beneficiary.full_name; if(beneficiary.relationship) div.querySelector('[name="relationship"]').value = beneficiary.relationship; if(beneficiary.percentage) div.querySelector('[name="percentage"]').value = beneficiary.percentage; div.querySelector('.remove-row-btn').addEventListener('click', () => { div.remove(); appState.isFormDirty = true; }); document.getElementById('beneficiaries-container').appendChild(clone); }
        function closeModal() { if (appState.isFormDirty && !confirm("You have unsaved changes. Are you sure you want to close?")) return; document.querySelectorAll('#enrollment-modal, #confirm-delete-modal, #settings-modal').forEach(m => m.classList.add('hidden')); appState.isFormDirty = false; }
        function openDeleteConfirm(employeeId) { const modal = document.getElementById('confirm-delete-modal'); modal.classList.remove('hidden'); const confirmBtn = modal.querySelector('#confirm-delete-action-btn'); const newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); newConfirmBtn.addEventListener('click', () => handleDelete(employeeId)); }
        function openSettingsModal() { const modal = document.getElementById('settings-modal'); modal.querySelector('#google-api-key').value = localStorage.getItem('googleApiKey') || ''; modal.classList.remove('hidden'); }
        function handleSettingsSave(event) { event.preventDefault(); const key = document.getElementById('google-api-key').value.trim(); if (key) { localStorage.setItem('googleApiKey', key); showToast('API Key saved!', 'success'); } else { localStorage.removeItem('googleApiKey'); showToast('API Key removed.', 'info'); } closeModal(); }
        async function handleDelete(employeeId) { const { error } = await supabaseClient.from('employees').delete().eq('id', employeeId); if (error) { showToast(`Error: ${error.message}`, 'error'); } else { showToast('Employee deleted.', 'success'); appState.selectedEmployeeId = null; fetchEmployees(true); renderEmptyState(); } closeModal(); }
        function validateForm(form) { const errors = []; form.querySelectorAll('.form-input.invalid').forEach(el => el.classList.remove('invalid')); const ssnInput = form.querySelector('[name="social_security_number"]'); if (ssnInput.value && !/^\d{3}-\d{2}-\d{4}$/.test(ssnInput.value)) { errors.push("SSN must be nnn-nn-nnnn."); ssnInput.classList.add('invalid'); } const phoneInput = form.querySelector('[name="phone"]'); if (phoneInput.value && !/^\d{3}-\d{3}-\d{4}$/.test(phoneInput.value)) { errors.push("Phone must be nnn-nnn-nnnn."); phoneInput.classList.add('invalid'); } let primaryTotal = 0; form.querySelectorAll('.beneficiary-row').forEach(row => { if (row.querySelector('[name="kind"]').value === 'Primary') primaryTotal += parseFloat(row.querySelector('[name="percentage"]').value) || 0; }); if (primaryTotal > 0 && primaryTotal !== 100) { errors.push(`Primary Beneficiary % must total 100. Current is ${primaryTotal}%.`); } const errorContainer = form.querySelector('#validation-errors'); if (errors.length > 0) { errorContainer.innerHTML = errors.map(e => `<p>${e}</p>`).join(''); errorContainer.classList.remove('hidden'); return false; } errorContainer.classList.add('hidden'); return true; }
        async function handleEnrollmentSubmit(event) { event.preventDefault(); const form = event.target; if (!validateForm(form)) { showToast('Please fix errors.', 'error'); return; } const modalLoader = document.getElementById('modal-loader'); modalLoader.classList.remove('hidden'); const employeeId = form.dataset.employeeId; const isEditMode = !!employeeId; const formData = new FormData(form); const employeeData = { full_name: formData.get('full_name'), birthdate: formData.get('birthdate'), phone: formData.get('phone'), social_security_number: formData.get('social_security_number'), email: formData.get('email'), gender: formData.get('gender'), address: formData.get('address'), city: formData.get('city'), state: formData.get('state'), zip: formData.get('zip'), date_of_hire: formData.get('date_of_hire'), occupation: formData.get('occupation'), status: formData.get('status'), actively_at_work: formData.has('actively_at_work'), used_tobacco_12mo: formData.has('used_tobacco_12mo'), any_disabled_proposed_insured: formData.has('any_disabled_proposed_insured'), title_xix_medicaid: formData.has('title_xix_medicaid'), }; if (isEditMode) employeeData.id = employeeId; const { data: savedEmployee, error: empError } = await supabaseClient.from('employees').upsert(employeeData).select().single(); if (empError) { showToast(empError.message, 'error'); modalLoader.classList.add('hidden'); return; } const newEmployeeId = savedEmployee.id; if (isEditMode) { await Promise.all([ supabaseClient.from('dependents').delete().eq('employee_id', newEmployeeId), supabaseClient.from('beneficiaries').delete().eq('employee_id', newEmployeeId), supabaseClient.from('elections').delete().eq('employee_id', newEmployeeId), ]); } const dependentsData = Array.from(form.querySelectorAll('.dependent-row')).map(row => ({ employee_id: newEmployeeId, rel_type: row.querySelector('[name="rel_type"]').value, full_name: row.querySelector('[name="dep_full_name"]').value, dob: row.querySelector('[name="dep_dob"]').value || null, gender: row.querySelector('[name="dep_gender"]').value, ssn: row.querySelector('[name="dep_ssn"]').value, })).filter(d => d.full_name); if (dependentsData.length > 0) await supabaseClient.from('dependents').insert(dependentsData); const beneficiariesData = Array.from(form.querySelectorAll('.beneficiary-row')).map(row => ({ employee_id: newEmployeeId, kind: row.querySelector('[name="kind"]').value, full_name: row.querySelector('[name="ben_full_name"]').value, relationship: row.querySelector('[name="relationship"]').value, percentage: row.querySelector('[name="percentage"]').value || null, })).filter(b => b.full_name); if (beneficiariesData.length > 0) await supabaseClient.from('beneficiaries').insert(beneficiariesData); const electionsData = []; form.querySelectorAll('.benefit-plan-form').forEach(planForm => { const planName = planForm.dataset.planName; planForm.querySelectorAll('input[type="radio"]:checked').forEach(radio => { electionsData.push({ employee_id: newEmployeeId, product: radio.dataset.product, carrier: 'Guardian Life', coverage_tier: radio.dataset.tier, premium_amount: radio.value, coverage_amount: radio.dataset.amount > 0 ? radio.dataset.amount : null, }); }); if (planName === 'Whole-Life' || planName === 'Term-Life') { const carrier = planName === 'Whole-Life' ? 'Allstate' : 'Guardian Life'; planForm.querySelectorAll('select').forEach(select => { if(select.value) { const tier = select.name.includes('employee') ? 'Employee' : 'Spouse'; electionsData.push({ product: planName, carrier: carrier, coverage_tier: tier, coverage_amount: select.value, employee_id: newEmployeeId }); } }); } }); if (electionsData.length > 0) await supabaseClient.from('elections').insert(electionsData); await supabaseClient.from('election_acknowledgements').upsert({ employee_id: newEmployeeId, declined_all: formData.has('decline_all'), signature_name: formData.get('signature_name'), signed_at: formData.get('signature_name') ? new Date().toISOString() : null }, { onConflict: 'employee_id' }); appState.isFormDirty = false; showToast(`Enrollment ${isEditMode ? 'updated' : 'submitted'}!`, 'success'); document.getElementById('enrollment-modal').classList.add('hidden'); await fetchEmployees(true); if (isEditMode || appState.employees.length === 1) await handleEmployeeSelection(newEmployeeId); else renderEmptyState(); modalLoader.classList.add('hidden'); }
        async function handleExportCSV() { showToast('Preparing export...', 'info'); const { data: employees, error: empError } = await supabaseClient.from('employees').select(`*, dependents(*), beneficiaries(*), elections(*)`).order('full_name', { ascending: true }); if (empError) { showToast(`Export failed: ${empError.message}`, 'error'); return; } if (employees.length === 0) { showToast('No data to export.', 'info'); return; } const flatData = []; employees.forEach(emp => { const baseEmployee = { 'Employee Name': emp.full_name, 'Status': emp.status, 'Email': emp.email, 'Phone': emp.phone, 'Address': `${emp.address || ''}, ${emp.city || ''}, ${emp.state || ''} ${emp.zip || ''}`, 'DOB': emp.birthdate, 'Hire Date': emp.date_of_hire, 'Occupation': emp.occupation }; if (emp.elections.length > 0) { emp.elections.forEach(election => { flatData.push({ ...baseEmployee, 'Benefit Product': election.product, 'Benefit Carrier': election.carrier, 'Coverage Tier': election.coverage_tier, 'Coverage Amount': election.coverage_amount, 'Premium': election.premium_amount, }); }); } else { flatData.push(baseEmployee); } }); const csv = Papa.unparse(flatData); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.setAttribute("href", URL.createObjectURL(blob)); link.setAttribute("download", `mvp_enrollment_export_${new Date().toISOString().split('T')[0]}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('Export successful!', 'success'); }
        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
        function showToast(message, type = 'success') { toastMessage.textContent = message; const colors = { success: 'bg-green-500', error: 'bg-red-600', info: 'bg-blue-500' }; toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${colors[type]}`; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 4000); }
        function maskSSN(ssn) { return ssn && ssn.length > 4 ? `***-**-${ssn.slice(-4)}` : 'N/A'; }
        function toggleSSN(fullSSN) { const ssnDisplay = document.getElementById('ssn-display'); const toggleBtn = document.getElementById('toggle-ssn-btn'); if (ssnDisplay.textContent.includes('*')) { ssnDisplay.textContent = fullSSN || 'N/A'; toggleBtn.textContent = '[Hide]'; } else { ssnDisplay.textContent = maskSSN(fullSSN); toggleBtn.textContent = '[Show]'; } }
        async function getAiSummary(employee, relatedData) { const summaryContainer = document.getElementById('summary-content'); if (!summaryContainer) return; const apiKey = localStorage.getItem('googleApiKey'); if (!apiKey) { summaryContainer.innerHTML = `<p class="text-yellow-400 text-sm">Add Google AI API key in Settings.</p>`; return; } summaryContainer.innerHTML = '<div class="h-16 w-full bg-slate-700/50 rounded animate-pulse"></div>'; const age = employee.birthdate ? Math.floor((new Date() - new Date(employee.birthdate).getTime()) / 3.15576e+10) : 'Unknown'; const electionsList = relatedData.elections.map(e => `- ${e.product} (${e.coverage_tier})`).join('\n'); const dependentsList = relatedData.dependents.map(d => `- ${d.full_name} (${d.rel_type})`).join('\n'); const prompt = `Briefly summarize this employee's HR file in one paragraph. No markdown. Data: Name: ${employee.full_name}, Status: ${employee.status}, Age: ${age}. Benefits: ${electionsList || 'None'}. Dependents: ${dependentsList || 'None'}`; try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const result = await response.json(); const text = result.candidates?.[0]?.content?.parts?.[0]?.text; summaryContainer.innerHTML = text ? `<p>${text}</p>` : `<p class="text-red-500">Could not generate summary.</p>`; } catch (error) { summaryContainer.innerHTML = `<p class="text-red-500">Summary failed. Check API key.</p>`; console.error("AI Summary Error:", error); } }
    </script>
</body>
</html>
